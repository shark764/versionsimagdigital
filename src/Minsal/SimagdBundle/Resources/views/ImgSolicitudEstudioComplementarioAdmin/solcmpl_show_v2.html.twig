{#

This file is part of the Sonata package.

(c) Thomas Rabaix <thomas.rabaix@sonata-project.org>

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.

#}

{% extends 'MinsalSimagdBundle::simagd_base_list_v2.html.twig' %}

{% block stylesheets %}
    {{ parent() }}

{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
	var $is_tcnlX;
	
	$is_tcnlX		= {% if is_granted('ROLE_MINSAL_SIMAGD_ADMIN_IMG_PROCEDIMIENTO_REALIZADO_CREATE') %} true {% else %} false {% endif %};

	console.log($is_tcnlX);
    </script>
    
    <script type="text/javascript" src="{{ asset('bundles/minsalsimagd/js/ImgSolicitudEstudioComplementarioAdmin/solcmpl_show_v2.js') }}" ></script>

{% endblock %}

{% block actions %}
{% endblock %}

{% block tab_menu %}{{ knp_menu_render(admin.sidemenu(action), {'currentClass' : 'active', 'template': admin_pool.getTemplate('tab_menu_template')}, 'twig') }}{% endblock %}
    
{% block simagd_navbar_menu_label %}
    <i class="fa fa-user-md"></i> <i class="fa fa-microphone"></i> <i class="fa fa-external-link"></i> <i class="fa fa-reply-all"></i> Solicitud ha sido guardada
{% endblock %}

{% block simagd_navbar_left_nav %}
    <li class="list-table-link-navbar {% if not ( is_granted('ROLE_MINSAL_SIMAGD_ADMIN_IMG_SOLICITUD_ESTUDIO_COMPLEMENTARIO_LIST') or is_granted('ROLE_ADMIN') ) %} disabled link-full-disabled {% endif %}">
	<a   title="Regresar a edición de formulario" target="_self" class=""
	    href="{{ admin.generateUrl('list') }}" autofocus>
	    <span class="text-info"> <i class="fa fa-wheelchair"></i> <i class="fa fa-user-md"></i> <i class="fa fa-microphone"></i> </span> Solicitudes de estudio complementario <span class="sr-only">(current)</span>
	</a>
    </li>
{% endblock %}

{% block simagd_navbar_right_nav %}
{% endblock %}
    
{% block sonata_admin_content -%}
    {{ parent() }}

    {% set studyPdr 		= solicitud.idEstudioPadre %}
    {% set expediente 		= studyPdr.idExpediente %}
    {% set prc_solicitud 	= solicitud.idSolicitudEstudio %}
    
    {% set item_listaPndR 	= null %}
    {% for noRealizado in solicitud.complementarioExamenPendienteRealizar if noRealizado.getIdProcedimientoIniciado() is null %}
	{% set item_listaPndR = noRealizado %}
    {% endfor %}
    
    <div class="anexo-nueva-solicitud">

        <div class="box box-danger">
            <div class="box-header">
                <h3 class="box-title">Solicitar nuevo estudio a partir de estudio padre</h3>
            </div>
            <div class="box-body">
		<table class="table table-hover table-condensed table-responsive table-borderless">
		    <tr>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">id:</span></th>
			<td colspan="3" class="col-md-9" ><span class="badge">{{ solicitud.id }}</span></td>
		    </tr>
		    <tr>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">Nombre:</span></th>
			<td class="col-md-3">{{ expediente.idPaciente }}</td>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">N° de Registro:</span></th>
			<td class="col-md-3"><span class="badge">{{ expediente.numero }}</span></td>
		    </tr>
		    <tr>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">Procedencia:</span></th>
			<td class="col-md-3">{{ prc_solicitud ? prc_solicitud.idAtenAreaModEstab.idAreaModEstab.idAreaAtencion : 'No especificado...' }}</td>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">Servicio clínico:</span></th>
			<td class="col-md-3">{{ prc_solicitud ? prc_solicitud.idAtenAreaModEstab.idAtencion : 'No especificado...' }}</td>
		    </tr>
		    <tr>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">Solicitado por:</span></th>
			<td class="col-md-3">{{ solicitud.idRadiologoSolicita }}</td>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">Se registró:</span></th>
			<td class="col-md-3">{{ solicitud.fechaSolicitud|format_date('EEEE, MMMM d, yyyy', 'es_ES') ~ ' ' ~ solicitud.fechaSolicitud|date('H:i:s A') }}</td>
		    </tr>
		    <tr>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">Justificación:</span></th>
			<td colspan="3" class="col-md-9" ><pre class="pre-display-code-natural">{{ solicitud.justificacion|trim|default('<span style="color: #bbb;">Sin especificar...</span>')|raw }}</pre></td>
		    </tr>
		    <tr>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">Indicaciones del radiólogo:</span></th>
			<td colspan="3" class="col-md-9" ><pre class="pre-display-code-no-natural">{{ solicitud.indicacionesEstudio|trim|default('<span style="color: #bbb;">Sin especificar...</span>')|raw }}</pre></td>
		    </tr>
		    <tr>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">Solicitado a:</span></th>
			<td class="col-md-3">{{ solicitud.idEstablecimientoSolicitado }} {% if app.user.getIdEstablecimiento.getId() == solicitud.idEstablecimientoSolicitado.getId() %} <span class="label label-element-v2" style="">[Servicio local]</span> {% endif %}</td>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">Prioridad requerida:</span></th>
			<td class="col-md-3"><span class="label label-{{ solicitud.idPrioridadAtencion.estiloPresentacion|default('primary-v4') }}">{{ solicitud.idPrioridadAtencion }}</span></td>
		    </tr>
		    <tr>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">Modalidad:</span></th>
			<td class="col-md-3">{{ solicitud.idAreaServicioDiagnostico }}</td>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">Complementa estudio de:</span></th>
			<td class="col-md-3">{{ prc_solicitud ? prc_solicitud.idAreaServicioDiagnostico : 'No especificado...' }}</td>
		    </tr>
		    <tr>
			<th class="col-md-3 simagd-th-text-primary"><span class="simagd-text-primary">Proyecciones:</span></th>
			<td colspan="3" class="col-md-9" >
			    {% set examenesLoop = [] %}
			    {% for proyeccion in solicitud.solicitudEstudioComplementarioProyeccion %}
				{% set i = '_' ~ proyeccion.idExamenServicioDiagnostico.id %}
				
				{% if i not in examenesLoop|keys %}
				    {% set examenesLoop = examenesLoop|merge({ (i): proyeccion.idExamenServicioDiagnostico }) %}
				{% endif %}
			    {% endfor %}
			    
			    <div class="panel-group" id="exm_containerGroup">
				{% for key, value in examenesLoop %}
				    
				    {% set exm_proyeccionCount = 0 %}
				    {% for proyeccion in solicitud.solicitudEstudioComplementarioProyeccion if proyeccion.idExamenServicioDiagnostico.id == key|trim('_') %}
					{% set exm_proyeccionCount = exm_proyeccionCount + 1 %}
				    {% endfor %}
				    
				    <div class="panel panel-primary-v4">
					<a   class="list-group-item btn-link btn-link-v2" data-toggle="collapse" href="#solcmpl_proyecciones_panelCollapse_id_{{ key }}">
					    <span class="badge">{{ exm_proyeccionCount }}</span>
					    {{ value }}
					</a>
					<div class="panel-collapse collapse" id="solcmpl_proyecciones_panelCollapse_id_{{ key }}">
					    <div class="panel-body">
						{% for proyeccion in solicitud.solicitudEstudioComplementarioProyeccion if proyeccion.idExamenServicioDiagnostico.id == key|trim('_') %}
						    <a    tabindex="0"
							class="list-group-item btn-link btn-link-v2"
							role="button"
							data-toggle="popover"
							rel="popover"
							data-trigger="hover"
							title="{{ proyeccion }}"
							data-original-title="{{ proyeccion }}"
							data-contentwrapper=".solcmpl_history_container_contentwrapper_id_{{ proyeccion.id }}"
							data-placement="top"
							href="javascript:void(0)"
							data-id="{{ proyeccion.id }}" >
							<span class="badge">{{ proyeccion.codigo }}</span>
							
							{{ proyeccion }}
						    </a>

						    <div class="solcmpl_history_container_contentwrapper_id_{{ proyeccion.id }}" style="display: none;"> <!-- Here i define my content and add an attribute data-contentwrapper t0 a selector-->
                                                        <table class="table table-condensed table-responsive table-borderless non-top-bordered-table full-collapse-bordered-table">
                                                            <tr><th class="col-md-5">Código:</th><td class="col-md-7">{{ proyeccion.codigo }}</td></tr>
                                                            <tr><th class="col-md-5">Tiempo en sala:</th><td class="col-md-7">{{ proyeccion.tiempoOcupacionSala }}</td></tr>
                                                            <tr><th class="col-md-5">Tiempo por médico:</th><td class="col-md-7">{{ proyeccion.tiempoMedico }}</td></tr>
                                                            <tr><th class="col-md-5">Descripción:</th><td class="col-md-7"><pre class="pre-display-code-natural">{{ proyeccion.descripcion|trim|default('<span style="color: #bbb;">Sin especificar...</span>')|raw }}</pre></td></tr>
                                                        </table>
						    </div>
						{% endfor %}
					    </div>
					</div>
				    </div>
				{% endfor %}
			    </div>
			</td>
		    </tr>
		    <tr>
			<th class="col-md-3"></th>
			<td colspan="3" class="col-md-9">
			    <div class="btn-toolbar" role="toolbar" aria-label="...">
				<div class="btn-group" role="group">
                                    <a   title="Recuperar estudio de Servidor PACS" target="_blank" class="btn btn-primary-v4 btn-outline btn-sm"
                                        href="{{ studyPdr ? studyPdr.url|raw|trim|default('javascript:void(0)') : 'javascript:void(0)' }}"
                                        {% if not ( is_granted('ROLE_MINSAL_SIMAGD_ADMIN_IMG_ESTUDIO_PACIENTE_VIEW') or is_granted('ROLE_ADMIN') ) %}
                                            disabled="disabled"
                                        {% endif %}>
                                        <i class="glyphicon glyphicon-eye-open"></i>
                                        Descargar</a>
				</div>
				<div class="btn-group" role="group">
                                    <a   title="Solicitar estudio complementario" target="_blank" class="btn btn-primary-v4 btn-outline btn-sm ml10"
                                        href="{{ studyPdr ? path('simagd_solicitud_estudio_complementario_create',
						    { '__prc' : prc_solicitud is not null ? prc_solicitud.id : null, '__est': studyPdr ? studyPdr.id : null }) : 'javascript:void(0)' }}"
                                        {% if not ( is_granted('ROLE_MINSAL_SIMAGD_ADMIN_IMG_SOLICITUD_ESTUDIO_COMPLEMENTARIO_CREATE') or is_granted('ROLE_ADMIN') ) or
						studyPdr.idEstudioPadre is not null %}
					    disabled="disabled"
					{% endif %}>
					<i class="glyphicon glyphicon-random"></i>
                                        Complementar</a>
				</div>
			    </div>
			</td>
		    </tr>
		    
		</table>
            </div>
        </div>

        <div class="box box-danger">
            <div class="box-body">
                ¿Desea agregar nueva solicitud de estudio complementario para estudio padre con estos datos?
            </div>
            <div class="box-footer clearfix">
		<div class="btn-toolbar" role="toolbar" aria-label="...">
		    <div class="btn-group" role="group">
			<a   title="Regresar a edición de formulario" target="_self" class="btn btn-primary-v4 btn-outline btn-sm "
			    href="{{ admin.generateObjectUrl('edit', solicitud) }}" autofocus>
			    <i class="fa fa-times"></i>
			    No, Regresar</a>
		    </div>
		    <div class="btn-group" role="group">
			<a   title="Registrar examen complementario" target="_self" class="btn btn-element-v2 btn-outline btn-sm "
			    href="{{ path('simagd_realizado_create', {
									'__prc' 	: prc_solicitud is not null ? prc_solicitud.id : null,
									'__cmpl'	: solicitud.id,
									'__pndR'	: item_listaPndR is not null ? item_listaPndR.id : null
								    }) }}"
			    {% if not ( is_granted('ROLE_MINSAL_SIMAGD_ADMIN_IMG_SOLICITUD_ESTUDIO_COMPLEMENTARIO_CREATE') or is_granted('ROLE_ADMIN') ) or expediente is null %}
				disabled="disabled"
			    {% endif %}>
			    <i class="fa fa-save"></i> <i class="fa fa-external-link"></i> <i class="fa fa-microphone"></i>
			    No, Examinar</a>
		    </div>
		    <div class="btn-group" role="group">
			<a   title="Solicitar otra modalidad" target="_self" class="btn btn-element-v2 btn-outline btn-sm "
			    href="{{ path('simagd_solicitud_estudio_complementario_create', {
									    '__prc'     : prc_solicitud is not null ? prc_solicitud.id : null,
									    '__est'     : studyPdr.id,
                                                                            '__cmpl'    : solicitud.id
									  }) }}"
			    {% if not ( is_granted('ROLE_MINSAL_SIMAGD_ADMIN_IMG_SOLICITUD_ESTUDIO_COMPLEMENTARIO_CREATE') or is_granted('ROLE_ADMIN') ) or expediente is null %}
				disabled="disabled"
			    {% endif %}>
			    <i class="fa fa-save"></i> <i class="fa fa-external-link"></i> <i class="fa fa-microphone"></i>
			    Si, Continuar</a>
		    </div>
		</div>
            </div>
        </div>
    </div>
    
    <div class="empty-layout-clear" style="height:76px;"></div>
{% endblock %}