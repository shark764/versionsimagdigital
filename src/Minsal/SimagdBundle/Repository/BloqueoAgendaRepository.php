<?php

namespace Minsal\SimagdBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * BloqueoAgendaRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class BloqueoAgendaRepository extends EntityRepository
{
    public function getCalendarLocks($id_estab, $start, $end, $idAreaServicioDiagnostico = null, $idTecnologo = null)
    {
        $query = $this->getEntityManager()
                        ->createQueryBuilder('blAgd')
                            ->select('blAgd')
                            ->addSelect('CONCAT(\'bl_\', blAgd.id) AS id, blAgd.diaCompleto AS allDay, blAgd.color AS color, blAgd.descripcion AS description, \'background\' AS rendering, blAgd.titulo AS title, blAgd.superposicion AS overlap')
                            // ->addSelect('CONCAT(\'bl_\', blAgd.id) AS id, blAgd.diaCompleto AS allDay, blAgd.color AS color, blAgd.descripcion AS description, \'background\' AS rendering, CONCAT(blAgd.titulo, \' (\', blAgd.fechaInicio, \' a \', blAgd.fechaFin, \', \', blAgd.horaInicio, \' a \', blAgd.horaFin, \') \') AS title')
                            ->addSelect('CONCAT(COALESCE(empblAgd.apellido, \'\'), \', \', COALESCE(empblAgd.nombre, \'\')) AS blAgd_empleado, empblAgd.id AS blAgd_id_empleado, tpEmp.tipo AS blAgd_tipoEmpleado')
                            ->addSelect('stdblAgd.nombre AS blAgd_establecimiento, stdblAgd.id AS blAgd_id_establecimiento, m.nombrearea AS blAgd_modalidad, m.id AS blAgd_id_area_servicio_diagnostico')
                            ->addSelect('usrRg.username AS blAgd_usernameUserReg, usrRg.id AS blAgd_id_userReg, usrMd.username AS blAgd_usernameUserMod, usrMd.id AS blAgd_id_userMod')
                            ->addSelect('CONCAT(COALESCE(usrRgEmp.apellido, \'\'), \', \', COALESCE(usrRgEmp.nombre, \'\')) AS blAgd_nombreUserReg')
                            ->addSelect('CASE WHEN (usrMd.username IS NOT NULL) THEN CONCAT(COALESCE(usrMdEmp.apellido, \'\'), \', \', COALESCE(usrMdEmp.nombre, \'\')) ELSE \'\' END AS blAgd_nombreUserMod')
                            ->addSelect('CASE WHEN (radx.id IS NOT NULL) THEN CONCAT(COALESCE(radx.apellido, \'\'), \', \', COALESCE(radx.nombre, \'\')) ELSE \'\' END AS blAgd_radiologo, radx.id AS blAgd_id_radiologo')
                            ->from('MinsalSimagdBundle:RyxBloqueoAgenda', 'blAgd')
                            ->innerJoin('blAgd.idEmpleadoRegistra', 'empblAgd')
                            ->innerJoin('blAgd.idEstablecimiento', 'stdblAgd')
                            ->leftJoin('blAgd.idRadiologoBloqueo', 'radx')
                            ->innerJoin('blAgd.idUserReg', 'usrRg')
                            ->leftJoin('blAgd.idUserMod', 'usrMd')
                            ->leftJoin('blAgd.idAreaServicioDiagnostico', 'm')
                            ->leftJoin('usrRg.idEmpleado', 'usrRgEmp')
                            ->leftJoin('usrMd.idEmpleado', 'usrMdEmp')
                            ->leftJoin('empblAgd.idTipoEmpleado', 'tpEmp')
                            ->where('blAgd.idEstablecimiento = :id_est')
                            ->setParameter('id_est', $id_estab);
        
        // if ($start && $end)
        // {
        //     $query->andWhere('blAgd.fechaInicio >= :cal_start_date')
        //                     ->andWhere('blAgd.fechaFin <= :cal_end_date')
        //                     ->setParameter('cal_start_date', \DateTime::createFromFormat('Y-m-d', $start)->setTime(0, 0))
        //                     ->setParameter('cal_end_date', \DateTime::createFromFormat('Y-m-d', $end)->setTime(0, 0));
        // }
        
        $query->andWhere($query->expr()->orx(
                                $query->expr()->eq('blAgd.idAreaServicioDiagnostico', ':id_mod'),
                                $query->expr()->isNull('blAgd.idAreaServicioDiagnostico')
                            ))
                            ->setParameter('id_mod', $idAreaServicioDiagnostico);
        
        $query->andWhere($query->expr()->orx(
                                $query->expr()->eq('blAgd.idRadiologoBloqueo', ':id_tcnl'),
                                $query->expr()->isNull('blAgd.idRadiologoBloqueo')
                            ))
                            ->setParameter('id_tcnl', $idTecnologo)
                            ->orderBy('blAgd.id', 'DESC')
                            ->distinct();
        
        return $query->getQuery()->getScalarResult();
    }
    
    public function data($id_estab, $bs_filters = array())
    {
        $query = $this->getEntityManager()
                        ->createQueryBuilder('blAgd')
                            ->select('blAgd')
                            ->addSelect('CONCAT(COALESCE(empblAgd.apellido, \'\'), \', \', COALESCE(empblAgd.nombre, \'\')) AS blAgd_empleado, empblAgd.id AS blAgd_id_empleado, tpEmp.tipo AS blAgd_tipoEmpleado')
                            ->addSelect('stdblAgd.nombre AS blAgd_establecimiento, stdblAgd.id AS blAgd_id_establecimiento, m.nombrearea AS blAgd_modalidad, m.id AS blAgd_id_area_servicio_diagnostico')
                            ->addSelect('usrRg.username AS blAgd_usernameUserReg, usrRg.id AS blAgd_id_userReg, usrMd.username AS blAgd_usernameUserMod, usrMd.id AS blAgd_id_userMod')
                            ->addSelect('CONCAT(COALESCE(usrRgEmp.apellido, \'\'), \', \', COALESCE(usrRgEmp.nombre, \'\')) AS blAgd_nombreUserReg')
                            ->addSelect('CASE WHEN (usrMd.username IS NOT NULL) THEN CONCAT(COALESCE(usrMdEmp.apellido, \'\'), \', \', COALESCE(usrMdEmp.nombre, \'\')) ELSE \'\' END AS blAgd_nombreUserMod')
                            ->addSelect('CASE WHEN (radx.id IS NOT NULL) THEN CONCAT(COALESCE(radx.apellido, \'\'), \', \', COALESCE(radx.nombre, \'\')) ELSE \'\' END AS blAgd_radiologo, radx.id AS blAgd_id_radiologo')
                            ->from('MinsalSimagdBundle:RyxBloqueoAgenda', 'blAgd')
                            ->innerJoin('blAgd.idEmpleadoRegistra', 'empblAgd')
                            ->leftJoin('blAgd.idRadiologoBloqueo', 'radx')
                            ->innerJoin('blAgd.idEstablecimiento', 'stdblAgd')
                            ->innerJoin('blAgd.idUserReg', 'usrRg')
                            ->leftJoin('blAgd.idUserMod', 'usrMd')
                            ->leftJoin('blAgd.idAreaServicioDiagnostico', 'm')
                            ->leftJoin('usrRg.idEmpleado', 'usrRgEmp')
                            ->leftJoin('usrMd.idEmpleado', 'usrMdEmp')
                            ->leftJoin('empblAgd.idTipoEmpleado', 'tpEmp')
                            ->where('blAgd.idEstablecimiento = :id_est')
                            ->setParameter('id_est', $id_estab);
        
        $query->orderBy('blAgd.id', 'DESC')
                            ->distinct();
        
        /*
         * --| add filters from BSTABLE_FILTER to query
         */
        $simagd_er_model    = $this->getEntityManager()->getRepository('MinsalSimagdBundle:ImgSolicitudEstudio');
        $apply_filters      = $simagd_er_model->getBsTableFiltersV2($query, $bs_filters);
        if ($apply_filters !== false)
        {
            $query->andWhere($apply_filters);
        }
        /*
         * |-- END filters from BSTABLE_FILTER to query
         */
        
        return $query->getQuery()->getScalarResult();
    }
    
    public function obtenerExclusionesBloqueo($id_blAgd)
    {
        $query = $this->getEntityManager()
                        ->createQueryBuilder('exclBlAgd')
                            ->select('exclBlAgd')
                            ->addSelect('IDENTITY(exclBlAgd.idRadiologoExcluido) AS exclBlAgd_id_radiologo')
                            ->from('MinsalSimagdBundle:ImgExclusionBloqueo', 'exclBlAgd')
                            ->where('exclBlAgd.idBloqueoAgenda = :id_blAgd')
                            ->setParameter('id_blAgd', $id_blAgd)
                            ->orderBy('exclBlAgd.idRadiologoExcluido', 'ASC')
                            ->distinct();

        return $query->getQuery()->getScalarResult();
    }
    
}