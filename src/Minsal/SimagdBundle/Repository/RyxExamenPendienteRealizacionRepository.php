<?php

namespace Minsal\SimagdBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * RyxExamenPendienteRealizacionRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class RyxExamenPendienteRealizacionRepository extends EntityRepository
{
    public function getWorkList($id_estab, $bs_filters = array(), $worklist_range_ = 'range')
    {
        /** SubQuery */
        $subQuery = $this->getEntityManager()
                        ->createQueryBuilder()
                            ->select('prz')
                            ->from('MinsalSimagdBundle:ImgProcedimientoRealizado', 'prz');
                           // ->where('prz.idEstadoProcedimientoRealizado NOT IN (5, 6, 7, 8, 9)');

        $subQuery->andWhere($subQuery->expr()->orx(
                            $subQuery->expr()->eq('prz.idSolicitudEstudio', 'pndR.idSolicitudEstudio'),
                            $subQuery->expr()->eq('prz.idCitaProgramada', 'pndR.idCitaProgramada'),
                            $subQuery->expr()->eq('prz.idSolicitudEstudioComplementario', 'pndR.idSolicitudEstudioComplementario')
                        ));
			    // ->where('prz.id = pndR.idProcedimientoIniciado');
			    // ->where('prz.idSolicitudEstudio = pndR.idSolicitudEstudio OR prz.idCitaProgramada = pndR.idCitaProgramada OR prz.idSolicitudEstudioComplementario = pndR.idSolicitudEstudioComplementario');

        /** Query */
        $query = $this->getEntityManager()
                        ->createQueryBuilder('pndR')
                            ->select('pndR')
                            ->addSelect('prc')
                            ->addSelect('cit')
                            ->addSelect('solcmpl')
                            ->addSelect('explocal')->addSelect('unknExp')
                            ->addSelect('prAtn')

                            ->addSelect('pndR.id AS id, stdroot.nombre AS origen, CONCAT(pct.primerApellido, \' \', COALESCE(pct.segundoApellido, \'\'), \', \', pct.primerNombre, \' \', COALESCE(pct.segundoNombre, \'\')) AS paciente, explocal.numero AS numero_expediente, CASE WHEN (empprc.id IS NOT NULL) THEN CONCAT(COALESCE(empprc.apellido, \'\'), \', \', COALESCE(empprc.nombre, \'\')) ELSE \'\' END AS medico, ar.nombre AS area_atencion, atn.nombre AS atencion, m.nombrearea AS modalidad, prAtn.nombre AS triage, pndR.fechaIngresoLista AS fecha_ingreso, CASE WHEN (tcnlcit.id IS NOT NULL) THEN CONCAT(COALESCE(tcnlcit.apellido, \'\'), \', \', COALESCE(tcnlcit.nombre, \'\')) ELSE \'\' END AS tecnologo')

                            ->addSelect('stdPndR.nombre AS pndR_establecimiento, stdPndR.id AS pndR_id_establecimiento')

                            ->addSelect('statuscit.id AS cit_id_estado, statuscit.nombreEstado AS cit_estado')
                            ->addSelect('CASE WHEN (empCit.id IS NOT NULL) THEN CONCAT(COALESCE(empCit.apellido, \'\'), \', \', COALESCE(empCit.nombre, \'\')) ELSE \'\' END AS cit_recepcionista, empCit.id AS cit_id_recepcionista')
                            ->addSelect('CASE WHEN (tcnlcit.id IS NOT NULL) THEN CONCAT(COALESCE(tcnlcit.apellido, \'\'), \', \', COALESCE(tcnlcit.nombre, \'\')) ELSE \'\' END AS cit_tecnologo, tcnlcit.id AS cit_id_tecnologo')

                            ->addSelect('CONCAT(pct.primerApellido, \' \', COALESCE(pct.segundoApellido, \'\'), \', \', pct.primerNombre, \' \', COALESCE(pct.segundoNombre, \'\')) AS prc_paciente')
                            ->addSelect('stdroot.nombre AS prc_origen, stdroot.id AS prc_id_origen, ar.nombre AS prc_areaAtencion, ar.id AS prc_id_areaAtencion, atn.nombre AS prc_atencion, atn.id AS prc_id_atencion')
                            ->addSelect('CASE WHEN (empprc.id IS NOT NULL) THEN CONCAT(COALESCE(empprc.apellido, \'\'), \', \', COALESCE(empprc.nombre, \'\')) ELSE \'\' END AS prc_solicitante')
                            ->addSelect('m.nombrearea AS prc_modalidad, m.id AS prc_id_modalidad, prAtn.nombre AS prc_prioridadAtencion, prAtn.codigo AS prc_codigoPrioridad, frCt.nombre AS prc_formaContacto, ctPct.parentesco AS prc_contactoPaciente')

                            ->addSelect('CASE WHEN (empcmpl.id IS NOT NULL) THEN CONCAT(COALESCE(empcmpl.apellido, \'\'), \', \', COALESCE(empcmpl.nombre, \'\')) ELSE \'\' END AS solcmpl_solicitante')
                            ->addSelect('mcmpl.nombrearea AS solcmpl_modalidad, prAtnCmpl.nombre AS solcmpl_prioridadAtencion, prAtnCmpl.codigo AS solcmpl_codigoPrioridad')

                            ->from('MinsalSimagdBundle:ImgPendienteRealizacion', 'pndR')
                            ->innerJoin('pndR.idEstablecimiento', 'stdPndR')

                            ->leftJoin('pndR.idSolicitudEstudio', 'prc')
                            ->leftJoin('prc.idAtenAreaModEstab', 'aams')
                            ->leftJoin('prc.idEmpleado', 'empprc')
                            ->leftJoin('prc.idAreaServicioDiagnostico', 'm')
                            ->leftJoin('prc.idPrioridadAtencion', 'prAtn')
                            ->leftJoin('prc.idFormaContacto', 'frCt')
                            ->leftJoin('prc.idContactoPaciente', 'ctPct')
                            ->leftJoin('aams.idAtencion', 'atn')
                            ->leftJoin('aams.idAreaModEstab', 'ams')
                            ->leftJoin('aams.idEstablecimiento', 'stdroot')
                            ->leftJoin('ams.idAreaAtencion', 'ar')
                            ->leftJoin('prc.idExpediente', 'exp')
                            ->leftJoin('exp.idPaciente', 'pct')

                            ->leftJoin('pndR.idSolicitudEstudioComplementario', 'solcmpl')
                            ->leftJoin('solcmpl.idAreaServicioDiagnostico', 'mcmpl')
                            ->leftJoin('solcmpl.idRadiologoSolicita', 'empcmpl')
                            ->leftJoin('solcmpl.idPrioridadAtencion', 'prAtnCmpl')

                            ->leftJoin('pndR.idCitaProgramada', 'cit')
                            ->leftJoin('cit.idEstadoCita', 'statuscit')
                            ->leftJoin('cit.idEmpleado', 'empCit')
                            ->leftJoin('cit.idTecnologoProgramado', 'tcnlcit')

                            ->where('pndR.idEstablecimiento = :id_est_ref')
                            ->setParameter('id_est_ref', $id_estab)
                            ->andWhere('pndR.idProcedimientoIniciado IS NULL')
                            ->orderBy('pndR.fechaIngresoLista', 'ASC')
                            ->addOrderBy('pndR.id', 'DESC');
        
        $query->leftJoin('prc.idExpedienteFicticio', 'unknExp')->leftJoin('MinsalSiapsBundle:MntExpediente', 'explocal',
                                    \Doctrine\ORM\Query\Expr\Join::WITH,
                                            $query->expr()->andx(
                                                $query->expr()->eq('pct.id', 'explocal.idPaciente'),
                                                $query->expr()->eq('explocal.idEstablecimiento', ':id_est_explocal')
                                            )
                            )
                            ->setParameter('id_est_explocal', $id_estab);

        if ($worklist_range_ === 'today') {
            $query->andWhere('cit.fechaHoraInicio >= :start_today_')
                            ->setParameter('start_today_', (new \DateTime('now'))->setTime(0, 0));
        }

        $query/*->andWhere($query->expr()->not($query->expr()->exists($subQuery->getDql())))*/
			    ->distinct();
        
        /*
         * --| add filters from BSTABLE_FILTER to query
         */
        $simagd_er_model    = $this->getEntityManager()->getRepository('MinsalSimagdBundle:ImgSolicitudEstudio');
        $apply_filters      = $simagd_er_model->getBsTableFiltersV2($query, $bs_filters);
        if ($apply_filters !== false)
        {
            $query->andWhere($apply_filters);
        }
        /*
         * |-- END filters from BSTABLE_FILTER to query
         */

        return $query->getQuery()->getScalarResult();
    }

    public function assignedWorkList($id_estab, $sessionUser, $bs_filters = array())
    {
        /** SubQuery */
        //         $subQuery = $this->getEntityManager()
        //                         ->createQueryBuilder()
        //                             ->select('prz')
        //                             ->from('MinsalSimagdBundle:ImgProcedimientoRealizado', 'prz');
        // //                            ->where('prz.idEstadoProcedimientoRealizado NOT IN (5, 6, 7, 8, 9)');
        //
        //         $subQuery->andWhere($subQuery->expr()->orx(
        //                             $subQuery->expr()->eq('prz.idSolicitudEstudio', 'pndR.idSolicitudEstudio'),
        //                             $subQuery->expr()->eq('prz.idCitaProgramada', 'pndR.idCitaProgramada'),
        //                             $subQuery->expr()->eq('prz.idSolicitudEstudioComplementario', 'pndR.idSolicitudEstudioComplementario')
        //                         ));
        // // 			    ->where('prz.id = pndR.idProcedimientoIniciado');
        // // 			    ->where('prz.idSolicitudEstudio = pndR.idSolicitudEstudio OR prz.idCitaProgramada = pndR.idCitaProgramada OR prz.idSolicitudEstudioComplementario = pndR.idSolicitudEstudioComplementario');

        /** Query */
        $query = $this->getEntityManager()
                        ->createQueryBuilder('pndR')
                            ->select('pndR')
                            ->addSelect('prz')
                            ->addSelect('prc')
                            ->addSelect('cit')
                            ->addSelect('solcmpl')
                            ->addSelect('explocal')->addSelect('unknExp')
                            ->addSelect('prAtn')

                            ->addSelect('stdPndR.nombre AS pndR_establecimiento, stdPndR.id AS pndR_id_establecimiento')

                            ->addSelect('statusprz.id AS prz_id_estado, statusprz.nombreEstado AS prz_estado, statusprz.codigo AS prz_codEstado')
                            ->addSelect('CONCAT(COALESCE(tcnlprz.apellido, \'\'), \', \', COALESCE(tcnlprz.nombre, \'\')) AS prz_tecnologo, tcnlprz.id AS prz_id_tecnologo')

                            ->addSelect('statuscit.id AS cit_id_estado, statuscit.nombreEstado AS cit_estado')
                            ->addSelect('CASE WHEN (empCit.id IS NOT NULL) THEN CONCAT(COALESCE(empCit.apellido, \'\'), \', \', COALESCE(empCit.nombre, \'\')) ELSE \'\' END AS cit_recepcionista, empCit.id AS cit_id_recepcionista')
                            ->addSelect('CASE WHEN (tcnlcit.id IS NOT NULL) THEN CONCAT(COALESCE(tcnlcit.apellido, \'\'), \', \', COALESCE(tcnlcit.nombre, \'\')) ELSE \'\' END AS cit_tecnologo, tcnlcit.id AS cit_id_tecnologo')

                            ->addSelect('CONCAT(pct.primerApellido, \' \', COALESCE(pct.segundoApellido, \'\'), \', \', pct.primerNombre, \' \', COALESCE(pct.segundoNombre, \'\')) AS prc_paciente')
                            ->addSelect('stdroot.nombre AS prc_origen, stdroot.id AS prc_id_origen, ar.nombre AS prc_areaAtencion, ar.id AS prc_id_areaAtencion, atn.nombre AS prc_atencion, atn.id AS prc_id_atencion')
                            ->addSelect('CASE WHEN (empprc.id IS NOT NULL) THEN CONCAT(COALESCE(empprc.apellido, \'\'), \', \', COALESCE(empprc.nombre, \'\')) ELSE \'\' END AS prc_solicitante')
                            ->addSelect('m.nombrearea AS prc_modalidad, m.id AS prc_id_modalidad, prAtn.nombre AS prc_prioridadAtencion, prAtn.codigo AS prc_codigoPrioridad, frCt.nombre AS prc_formaContacto, ctPct.parentesco AS prc_contactoPaciente')

                            ->addSelect('CASE WHEN (empcmpl.id IS NOT NULL) THEN CONCAT(COALESCE(empcmpl.apellido, \'\'), \', \', COALESCE(empcmpl.nombre, \'\')) ELSE \'\' END AS solcmpl_solicitante')
                            ->addSelect('mcmpl.nombrearea AS solcmpl_modalidad, prAtnCmpl.nombre AS solcmpl_prioridadAtencion, prAtnCmpl.codigo AS solcmpl_codigoPrioridad')

                            ->from('MinsalSimagdBundle:ImgPendienteRealizacion', 'pndR')
                            ->innerJoin('pndR.idEstablecimiento', 'stdPndR')

                            ->innerJoin('pndR.idProcedimientoIniciado', 'prz')
                            ->innerJoin('prz.idEstadoProcedimientoRealizado', 'statusprz')
                            ->innerJoin('prz.idTecnologoRealiza', 'tcnlprz')

                            /** SIEMPRE DEBE HABER UN PRC, AUNQ VENGA DE SOLCMPL, SOLCMPL->idSolicitudEstudio */
                            ->leftJoin('pndR.idSolicitudEstudio', 'prc')
                            ->leftJoin('prc.idAtenAreaModEstab', 'aams')
                            ->leftJoin('prc.idEmpleado', 'empprc')
                            ->leftJoin('prc.idAreaServicioDiagnostico', 'm')
                            ->leftJoin('prc.idPrioridadAtencion', 'prAtn')
                            ->leftJoin('prc.idFormaContacto', 'frCt')
                            ->leftJoin('prc.idContactoPaciente', 'ctPct')
                            ->leftJoin('aams.idAtencion', 'atn')
                            ->leftJoin('aams.idAreaModEstab', 'ams')
                            ->leftJoin('aams.idEstablecimiento', 'stdroot')
                            ->leftJoin('ams.idAreaAtencion', 'ar')
                            ->leftJoin('prc.idExpediente', 'exp')
                            ->leftJoin('exp.idPaciente', 'pct')

                            ->leftJoin('pndR.idSolicitudEstudioComplementario', 'solcmpl')
                            ->leftJoin('solcmpl.idAreaServicioDiagnostico', 'mcmpl')
                            ->leftJoin('solcmpl.idRadiologoSolicita', 'empcmpl')
                            ->leftJoin('solcmpl.idPrioridadAtencion', 'prAtnCmpl')

                            ->leftJoin('pndR.idCitaProgramada', 'cit')
                            ->leftJoin('cit.idEstadoCita', 'statuscit')
                            ->leftJoin('cit.idEmpleado', 'empCit')
                            ->leftJoin('cit.idTecnologoProgramado', 'tcnlcit')

                            ->where('pndR.idEstablecimiento = :id_est_ref')
                            ->setParameter('id_est_ref', $id_estab)
                            ->andWhere('prz.idUserReg = :id_user')
                            ->setParameter('id_user', $sessionUser)
                            ->andWhere('statusprz.codigo NOT IN (:status_prz_cod)')
                            ->setParameter('status_prz_cod', array('ALM', 'CNL', 'RZD', 'DCT', 'PST'))
                            ->orderBy('pndR.fechaIngresoLista', 'ASC')
                            ->addOrderBy('pndR.id', 'DESC')
                            ->distinct();
        
        $query->leftJoin('prc.idExpedienteFicticio', 'unknExp')->leftJoin('MinsalSiapsBundle:MntExpediente', 'explocal',
                                    \Doctrine\ORM\Query\Expr\Join::WITH,
                                            $query->expr()->andx(
                                                $query->expr()->eq('pct.id', 'explocal.idPaciente'),
                                                $query->expr()->eq('explocal.idEstablecimiento', ':id_est_explocal')
                                            )
                            )
                            ->setParameter('id_est_explocal', $id_estab);
        
        /*
         * --| add filters from BSTABLE_FILTER to query
         */
        $simagd_er_model    = $this->getEntityManager()->getRepository('MinsalSimagdBundle:ImgSolicitudEstudio');
        $apply_filters      = $simagd_er_model->getBsTableFiltersV2($query, $bs_filters);
        if ($apply_filters !== false)
        {
            $query->andWhere($apply_filters);
        }
        /*
         * |-- END filters from BSTABLE_FILTER to query
         */

        return $query->getQuery()->getScalarResult();
    }

}