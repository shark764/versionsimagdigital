<?php

namespace Minsal\SimagdBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * SolicitudDiagnosticoRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SolicitudDiagnosticoRepository extends EntityRepository
{
    public function obtenerAccesoSolDiagEstab($id, $idEstab)
    {
        $query = $this->getEntityManager()
                        ->createQueryBuilder()
                            ->select('soldiag.id AS soldiagId')
                            ->from('MinsalSimagdBundle:RyxSolicitudDiagnosticoPostEstudio', 'soldiag')
                            ->innerJoin('soldiag.idSolicitudEstudio', 'prc')
                            ->innerJoin('prc.idAtenAreaModEstab', 'aams')
                            ->where('soldiag.id = :id_soldiag')
                            ->setParameter('id_soldiag', $id);

        $query->andWhere($query->expr()->orx(
                            $query->expr()->eq('soldiag.idEstablecimientoSolicitado', ':id_est_sol'),
                            $query->expr()->eq('aams.idEstablecimiento', ':id_est')
                        ))
                            ->setParameter('id_est_sol', $idEstab)
                            ->setParameter('id_est', $idEstab);

        $query->distinct();
        $query->setMaxResults(1);
        
        return $query->getQuery()->getOneOrNullResult() ? true : false;
    }
    
    public function obtenerAccesoSolDiag($id, $idUser)
    {
        $query = $this->getEntityManager()
                        ->createQueryBuilder()
                            ->select('soldiag.id AS soldiagId')
                            ->from('MinsalSimagdBundle:RyxSolicitudDiagnosticoPostEstudio', 'soldiag')
                            ->where('soldiag.id = :id_soldiag')
                            ->setParameter('id_soldiag', $id)
                            ->andWhere('soldiag.idUserReg = :id_user_soldiag_reg')
                            ->setParameter('id_user_soldiag_reg', $idUser);

        $query->distinct();
        $query->setMaxResults(1);
        
        return $query->getQuery()->getOneOrNullResult() ? true : false;
    }
    
    public function obtenerAccesoSolDiagEstabEdit($id, $idEstab)
    {
        $query = $this->getEntityManager()
                        ->createQueryBuilder()
                            ->select('soldiag.id AS soldiagId')
                            ->from('MinsalSimagdBundle:RyxSolicitudDiagnosticoPostEstudio', 'soldiag')
                            ->innerJoin('soldiag.idSolicitudEstudio', 'prc')
                            ->innerJoin('prc.idAtenAreaModEstab', 'aams')
                            ->where('soldiag.id = :id_soldiag')
                            ->setParameter('id_soldiag', $id)
                            ->andWhere('aams.idEstablecimiento = :id_est')
                            ->setParameter('id_est', $idEstab);

        $query->distinct();
        $query->setMaxResults(1);
        
        return $query->getQuery()->getOneOrNullResult() ? true : false;
    }
    
    public function bloquearSolDiagnostico($idPrc = '-1')
    {
        $prc_er_model    = $this->getEntityManager()->getRepository('MinsalSimagdBundle:RyxSolicitudEstudio');  // --| entity manager for RyxSolicitudEstudio
        
        return ($prc_er_model->estudioPreinscritoFueAlmacenado($idPrc) || $prc_er_model->existeRegistroPorPreinscripcion($idPrc, 'soldiag', 'RyxSolicitudDiagnosticoPostEstudio') ||
                        $prc_er_model->existeLecturaPorPreinscripcion($idPrc));
    }
    
    public function obtenerSolicitudesDiagnostico($id_estab, $bs_filters = array())
    {
        $query = $this->getEntityManager()
                        ->createQueryBuilder()
                            ->select('soldiag')
                            ->from('MinsalSimagdBundle:RyxSolicitudDiagnosticoPostEstudio', 'soldiag')
                            ->innerJoin('soldiag.idSolicitudEstudio', 'prc')
                            ->innerJoin('prc.idAtenAreaModEstab', 'aams');

        $query->where($query->expr()->orx(
                            $query->expr()->eq('soldiag.idEstablecimientoSolicitado', ':id_est_sol'),
                            $query->expr()->eq('aams.idEstablecimiento', ':id_est')
                        ))
                            ->setParameter('id_est_sol', $id_estab)
                            ->setParameter('id_est', $id_estab);
        
        $query->orderBy('soldiag.fechaCreacion', 'DESC')
                            ->addOrderBy('soldiag.id', 'DESC');
                
        $query->distinct();
        
        return $query->getQuery()->getResult();
    }

    public function data($id_estab, $bs_filters = array())
    {
        $query = $this->getEntityManager()
                        ->createQueryBuilder('soldiag')
                            ->select('soldiag')
                            ->addSelect('explocal')->addSelect('unknExp')
                            ->addSelect('prAtn')

                            ->addSelect('soldiag.id AS id, stdroot.nombre AS origen, CONCAT(pct.primerApellido, \' \', COALESCE(pct.segundoApellido, \'\'), \', \', pct.primerNombre, \' \', COALESCE(pct.segundoNombre, \'\')) AS paciente, explocal.numero AS numero_expediente, CASE WHEN (empsoldiag.id IS NOT NULL) THEN CONCAT(COALESCE(empsoldiag.apellido, \'\'), \', \', COALESCE(empsoldiag.nombre, \'\')) ELSE \'\' END AS medico, ar.nombre AS area_atencion, atn.nombre AS atencion, m.nombrearea AS modalidad, prAtn.nombre AS triage, soldiag.fechaCreacion AS fecha_solicitud, CASE WHEN (tcnlprz.id IS NOT NULL) THEN CONCAT(COALESCE(tcnlprz.apellido, \'\'), \', \', COALESCE(tcnlprz.nombre, \'\')) ELSE \'\' END AS tecnologo')

                            ->addSelect('prc.fechaCreacion AS prc_fechaCreacion, est.id AS est_id, est.fechaEstudio AS est_fechaEstudio, est.url AS est_url, prz.fechaAlmacenado AS prz_fechaAlmacenado, prz.fechaNacimientoIndeterminada AS prz_fechaNacimientoIndeterminada')
                            ->addSelect('CONCAT(pct.primerApellido, \' \', COALESCE(pct.segundoApellido, \'\'), \', \', pct.primerNombre, \' \', COALESCE(pct.segundoNombre, \'\')) AS prc_paciente')
                            ->addSelect('stdroot.nombre AS prc_origen, stdroot.id AS prc_id_origen, ar.nombre AS prc_areaAtencion, ar.id AS prc_id_areaAtencion, atn.nombre AS prc_atencion, atn.id AS prc_id_atencion')
                            ->addSelect('CONCAT(COALESCE(empsoldiag.apellido, \'\'), \', \', COALESCE(empsoldiag.nombre, \'\')) AS soldiag_solicitante, empsoldiag.id AS soldiag_id_solicitante, tpEmp.tipo AS soldiag_tipoEmpleado')
                            ->addSelect('stdref.nombre AS prc_referido, stdref.id AS prc_id_referido, stdiag.nombre AS prc_diagnosticante, stdiag.id AS prc_id_diagnosticante, stdsol.nombre AS soldiag_solicitado, stdsol.id AS soldiag_id_solicitado')
                            ->addSelect('m.nombrearea AS prc_modalidad, m.id AS prc_id_modalidad, prAtn.nombre AS prc_prioridadAtencion, prAtn.codigo AS prc_codigoPrioridad, frCt.nombre AS prc_formaContacto, ctPct.parentesco AS prc_contactoPaciente')
                            ->addSelect('usrRg.username AS soldiag_usernameUserReg, usrRg.id AS soldiag_id_userReg')
                            ->addSelect('CONCAT(COALESCE(usrRgEmp.apellido, \'\'), \', \', COALESCE(usrRgEmp.nombre, \'\')) AS soldiag_nombreUserReg')
                            ->addSelect('CASE WHEN (tcnlprz.id IS NOT NULL) THEN CONCAT(COALESCE(tcnlprz.apellido, \'\'), \', \', COALESCE(tcnlprz.nombre, \'\')) ELSE \'\' END AS prz_tecnologo')
                            ->from('MinsalSimagdBundle:RyxSolicitudDiagnosticoPostEstudio', 'soldiag')
                            ->innerJoin('soldiag.idSolicitudEstudio', 'prc')
                            ->leftJoin('soldiag.idEstudio', 'est')
                            ->leftJoin('est.idProcedimientoRealizado', 'prz')
                            ->leftJoin('prz.idTecnologoRealiza', 'tcnlprz')
                            ->innerJoin('soldiag.idEmpleado', 'empsoldiag')
                            ->innerJoin('prc.idAtenAreaModEstab', 'aams')
                            ->innerJoin('soldiag.idUserReg', 'usrRg')
                            ->leftJoin('prc.idExpediente', 'exp')
                            ->innerJoin('prc.idAreaServicioDiagnostico', 'm')
                            ->innerJoin('prc.idEstablecimientoReferido', 'stdref')
                            ->leftJoin('prc.idEstablecimientoDiagnosticante', 'stdiag')
                            ->leftJoin('soldiag.idEstablecimientoSolicitado', 'stdsol')
                            ->leftJoin('prc.idPrioridadAtencion', 'prAtn')
                            ->leftJoin('prc.idFormaContacto', 'frCt')
                            ->leftJoin('prc.idContactoPaciente', 'ctPct')
                            ->innerJoin('aams.idAtencion', 'atn')
                            ->innerJoin('aams.idAreaModEstab', 'ams')
                            ->innerJoin('aams.idEstablecimiento', 'stdroot')
                            ->innerJoin('ams.idAreaAtencion', 'ar')
                            ->leftJoin('exp.idPaciente', 'pct')
                            ->leftJoin('usrRg.idEmpleado', 'usrRgEmp')
                            ->leftJoin('empsoldiag.idTipoEmpleado', 'tpEmp');
        
        $query->leftJoin('prc.idExpedienteFicticio', 'unknExp')->leftJoin('MinsalSiapsBundle:MntExpediente', 'explocal',
                                    \Doctrine\ORM\Query\Expr\Join::WITH,
                                            $query->expr()->andx(
                                                $query->expr()->eq('pct.id', 'explocal.idPaciente'),
                                                $query->expr()->eq('explocal.idEstablecimiento', ':id_est_explocal')
                                            )
                            )
                            ->setParameter('id_est_explocal', $id_estab);

        $query->andWhere($query->expr()->orx(
                            $query->expr()->eq('soldiag.idEstablecimientoSolicitado', ':id_est_sol'),
                            $query->expr()->eq('aams.idEstablecimiento', ':id_est')
                        ))
                            ->setParameter('id_est_sol', $id_estab)
                            ->setParameter('id_est', $id_estab);

        $query->orderBy('soldiag.fechaCreacion', 'DESC')
                            ->addOrderBy('soldiag.id', 'DESC')
                            ->distinct();
        
        /*
         * --| add filters from BSTABLE_FILTER to query
         */
        $simagd_er_model    = $this->getEntityManager()->getRepository('MinsalSimagdBundle:RyxSolicitudEstudio');
        $apply_filters      = $simagd_er_model->getBsTableFiltersV2($query, $bs_filters);
        if ($apply_filters !== false)
        {
            $query->andWhere($apply_filters);
        }
        /*
         * |-- END filters from BSTABLE_FILTER to query
         */

        return $query->getQuery()->getScalarResult();
    }

}